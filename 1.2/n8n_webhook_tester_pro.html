<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n Webhook Testing Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f5f7fa 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .header-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .header-item {
            padding: 8px 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .main-workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 400px;
            min-width: 300px;
            max-width: 600px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        .sidebar-title {
            font-size: 1.3em;
            margin-bottom: 8px;
            color: #1976d2;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: #dee2e6;
            cursor: col-resize;
            transition: background-color 0.2s ease;
        }

        .resize-handle:hover {
            background: #1976d2;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        .content-title {
            font-size: 1.3em;
            color: #2c3e50;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .content-subtitle {
            color: #6c757d;
            font-size: 0.95em;
        }

        .content-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .response-panel, .chat-panel, .workflow-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            margin-bottom: 25px;
        }

        .panel-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 10px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        input[type="url"], input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="url"]:focus, input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25,118,210,0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.5;
        }

        .headers-container {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .header-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .header-row:last-child {
            margin-bottom: 0;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25,118,210,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            font-size: 12px;
            padding: 8px 12px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            font-size: 12px;
            padding: 8px 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
            font-size: 12px;
            padding: 8px 12px;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
            font-size: 12px;
            padding: 8px 12px;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .send-button {
            width: 100%;
            font-size: 16px;
            padding: 15px;
            margin-top: 20px;
        }

        .response-content {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            position: relative;
        }

        .response-html {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            white-space: normal;
            line-height: 1.6;
        }

        .response-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .response-tab {
            padding: 12px 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-bottom: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 2px;
            color: #6c757d;
        }

        .response-tab.active {
            background: white;
            border-bottom: 2px solid white;
            color: #1976d2;
        }

        .response-tab:hover {
            background: #e9ecef;
        }

        .response-tab.active:hover {
            background: white;
        }

        .response-view {
            display: none;
        }

        .response-view.active {
            display: block;
        }

        .response-raw {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .response-content pre {
            margin: 0;
            padding: 0;
            background: transparent;
            border: none;
            font-size: inherit;
            line-height: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .json-formatter {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .json-formatter button {
            margin-right: 10px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 8px 14px;
            border: 1px solid #1976d2;
            background: white;
            color: #1976d2;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .preset-btn:hover {
            background: #1976d2;
            color: white;
        }

        .history-panel, .workflow-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        .history-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: #1976d2;
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(25,118,210,0.1);
        }

        .history-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .history-url {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 5px;
        }

        .history-status {
            font-size: 12px;
        }

        .environment-selector {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .env-tabs {
            display: flex;
            gap: 5px;
        }

        .env-tab {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .env-tab.active {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }

        .load-test-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .load-test-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .rate-limit-warning {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #0c5460;
        }

        .schema-validator {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .auth-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .auth-types {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .auth-type {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 4px;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .auth-type.active {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }

        .auth-fields {
            display: none;
        }

        .auth-fields.active {
            display: block;
        }

        .monitoring-panel {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .monitoring-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #28a745;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .webhook-builder {
            background: #f0f8ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .builder-row {
            display: grid;
            grid-template-columns: 120px 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        @media (max-width: 1024px) {
            .main-workspace {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-width: 100%;
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            .resize-handle {
                display: none;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header {
                padding: 15px 20px;
            }

            .header-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .content-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>n8n Webhook Tester Pro</h1>
            <p>Professional testing suite for n8n workflows with monitoring and validation</p>
            <div class="header-info">
                <div class="header-item">
                    <strong>Session ID:</strong> <span id="sessionDisplay"></span>
                </div>
                <div class="header-item">
                    <strong>Status:</strong> <span id="connectionStatus">Ready</span>
                </div>
            </div>
        </div>

        <div class="main-workspace">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">🚀 Request Configuration</div>
                    <div style="font-size: 0.9em; color: #6c757d;">Configure your webhook request parameters</div>
                </div>
                
                <div class="sidebar-content">
                    <!-- Environment Management -->
                    <div class="form-group">
                        <label>Environment</label>
                        <div class="environment-selector">
                            <select id="environmentSelect">
                                <option value="custom">Custom URL</option>
                                <option value="dev">Development</option>
                                <option value="staging">Staging</option>
                                <option value="production">Production</option>
                            </select>
                            <button type="button" class="btn btn-secondary" onclick="manageEnvironments()">Manage</button>
                        </div>
                    </div>

                    <!-- Webhook URL Builder -->
                    <div class="webhook-builder">
                        <h4>🔗 Webhook URL Builder</h4>
                        <div class="builder-row">
                            <label>Base URL:</label>
                            <input type="text" id="baseUrl" placeholder="https://your-n8n-instance.com" value="">
                            <button type="button" class="btn btn-secondary" onclick="testConnection()">Test</button>
                        </div>
                        <div class="builder-row">
                            <label>Webhook Path:</label>
                            <input type="text" id="webhookPath" placeholder="/webhook/your-path" value="">
                            <button type="button" class="btn btn-secondary" onclick="buildUrl()">Build</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="webhookUrl">Webhook URL</label>
                        <input type="url" id="webhookUrl" placeholder="https://your-n8n-instance.com/webhook/your-webhook-path">
                    </div>

                    <div class="form-group">
                        <label for="httpMethod">HTTP Method</label>
                        <select id="httpMethod">
                            <option value="POST">POST</option>
                            <option value="GET">GET</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                    </div>

                    <!-- Authentication Panel -->
                    <div class="auth-panel">
                        <h4>🔐 Authentication</h4>
                        <div class="auth-types">
                            <div class="auth-type active" data-auth="none" onclick="switchAuth('none')">None</div>
                            <div class="auth-type" data-auth="bearer" onclick="switchAuth('bearer')">Bearer Token</div>
                            <div class="auth-type" data-auth="basic" onclick="switchAuth('basic')">Basic Auth</div>
                            <div class="auth-type" data-auth="apikey" onclick="switchAuth('apikey')">API Key</div>
                        </div>
                        <div id="authNone" class="auth-fields active">
                            <p style="color: #666; font-size: 12px;">No authentication required</p>
                        </div>
                        <div id="authBearer" class="auth-fields">
                            <input type="text" id="bearerToken" placeholder="Enter Bearer Token">
                        </div>
                        <div id="authBasic" class="auth-fields">
                            <input type="text" id="basicUsername" placeholder="Username" style="margin-bottom: 10px;">
                            <input type="password" id="basicPassword" placeholder="Password">
                        </div>
                        <div id="authApikey" class="auth-fields">
                            <input type="text" id="apiKeyName" placeholder="Header Name (e.g., X-API-Key)" style="margin-bottom: 10px;">
                            <input type="text" id="apiKeyValue" placeholder="API Key Value">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Headers</label>
                        <div class="headers-container" id="headersContainer">
                            <div class="header-row">
                                <input type="text" placeholder="Header Name" class="header-name">
                                <input type="text" placeholder="Header Value" class="header-value">
                                <button type="button" class="btn btn-danger" onclick="removeHeader(this)">Remove</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addHeader()" style="margin-top: 10px;">Add Header</button>
                    </div>

                    <div class="form-group">
                        <label for="requestBody">Request Body (JSON)</label>
                        <div class="preset-buttons">
                            <button type="button" class="preset-btn" onclick="loadPreset('basic')">Basic Test</button>
                            <button type="button" class="preset-btn" onclick="loadPreset('user')">User Data</button>
                            <button type="button" class="preset-btn" onclick="loadPreset('order')">Order Data</button>
                            <button type="button" class="preset-btn" onclick="loadPreset('webhook')">Webhook Event</button>
                            <button type="button" class="preset-btn" onclick="loadPreset('empty')">Empty</button>
                        </div>
                        <textarea id="requestBody" placeholder='{"message": "Hello n8n!", "timestamp": "2024-01-01T00:00:00Z"}'></textarea>
                        <div class="json-formatter">
                            <button type="button" class="btn btn-success" onclick="formatJson()">Format JSON</button>
                            <button type="button" class="btn btn-secondary" onclick="minifyJson()">Minify JSON</button>
                            <button type="button" class="btn btn-secondary" onclick="validateJson()">Validate JSON</button>
                            <button type="button" class="btn btn-warning" onclick="generateSchema()">Generate Schema</button>
                        </div>
                    </div>

                    <!-- Load Testing Panel -->
                    <div class="load-test-panel">
                        <h4>⚡ Load Testing</h4>
                        <div class="rate-limit-warning">
                            <strong>⚠️ Rate Limit:</strong> Maximum 50 requests per minute to prevent abuse
                        </div>
                        <div class="load-test-controls">
                            <div>
                                <label for="requestCount">Requests:</label>
                                <input type="number" id="requestCount" value="10" min="1" max="100">
                            </div>
                            <div>
                                <label for="requestDelay">Delay (ms):</label>
                                <input type="number" id="requestDelay" value="1000" min="100" max="10000">
                            </div>
                            <div>
                                <label for="concurrent">Concurrent:</label>
                                <input type="number" id="concurrent" value="1" min="1" max="10">
                            </div>
                            <button type="button" class="btn btn-warning" onclick="startLoadTest()">Start Load Test</button>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary send-button" onclick="sendWebhook()">
                        Send Webhook
                    </button>
                </div>

                <div class="resize-handle" id="resizeHandle"></div>
            </div>

            <div class="main-content">
                <div class="content-header">
                    <div class="content-title">📥 Response & Analysis</div>
                    <div class="content-subtitle">View and analyze webhook responses with professional formatting</div>
                </div>

                <div class="content-body">
                    <div class="response-panel">
                        <div id="responseStatus"></div>
                        
                        <div id="responseTabs" class="response-tabs" style="display: none;">
                            <div class="response-tab active" data-tab="formatted" onclick="switchTab('formatted')">Formatted</div>
                            <div class="response-tab" data-tab="raw" onclick="switchTab('raw')">Raw</div>
                            <div class="response-tab" data-tab="preview" onclick="switchTab('preview')" style="display: none;">HTML Preview</div>
                            <div class="response-tab" data-tab="headers" onclick="switchTab('headers')">Headers</div>
                            <div class="response-tab" data-tab="analysis" onclick="switchTab('analysis')">Analysis</div>
                        </div>

                        <div class="response-content" id="responseContent">
                            <div id="formattedView" class="response-view active">
                                <div style="text-align: center; color: #666; margin-top: 100px;">
                                    <p>No response yet. Send a webhook to see the response here.</p>
                                </div>
                            </div>
                            <div id="rawView" class="response-view">
                                <div class="response-raw" id="rawContent"></div>
                            </div>
                            <div id="previewView" class="response-view">
                                <iframe id="htmlPreview" style="width: 100%; height: 400px; border: 1px solid #e9ecef; border-radius: 6px;"></iframe>
                            </div>
                            <div id="headersView" class="response-view">
                                <div class="response-raw" id="headersContent"></div>
                            </div>
                            <div id="analysisView" class="response-view">
                                <div class="response-raw" id="analysisContent"></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button type="button" class="btn btn-secondary" onclick="clearResponse()">Clear Response</button>
                            <button type="button" class="btn btn-secondary" onclick="copyResponse()">Copy Response</button>
                            <button type="button" class="btn btn-secondary" onclick="downloadResponse()">Download Response</button>
                            <button type="button" class="btn btn-success" onclick="exportPostman()">Export to Postman</button>
                        </div>

                        <!-- Monitoring Panel -->
                        <div class="monitoring-panel">
                            <h4>📊 Performance Monitoring</h4>
                            <div class="monitoring-stats">
                                <div class="stat-item">
                                    <div class="stat-value" id="totalRequests">0</div>
                                    <div class="stat-label">Total Requests</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="avgResponseTime">0ms</div>
                                    <div class="stat-label">Avg Response Time</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="successRate">100%</div>
                                    <div class="stat-label">Success Rate</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="lastResponseSize">0B</div>
                                    <div class="stat-label">Last Response Size</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Panel -->
                    <div class="chat-panel">
                        <h2 class="panel-title">💬 Chat Tester</h2>
                        <div class="form-group">
                            <label for="chatTriggerUrl">Chat Trigger URL</label>
                            <input type="url" id="chatTriggerUrl" placeholder="https://your-n8n-instance.com/webhook/chat-trigger">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="testChat()">Test Chat</button>
                        <div id="chatContainer" style="margin-top: 20px;"></div>
                    </div>

                    <!-- Schema Validation Panel -->
                    <div class="workflow-panel">
                        <h2 class="panel-title">🔍 Schema Validation & Testing</h2>
                        
                        <div class="schema-validator">
                            <h4>JSON Schema Validator</h4>
                            <textarea id="jsonSchema" placeholder='{"type": "object", "properties": {"name": {"type": "string"}}, "required": ["name"]}' style="height: 120px;"></textarea>
                            <div style="margin-top: 10px;">
                                <button type="button" class="btn btn-success" onclick="validateAgainstSchema()">Validate Request</button>
                                <button type="button" class="btn btn-secondary" onclick="generateSampleData()">Generate Sample</button>
                            </div>
                            <div id="validationResults" style="margin-top: 15px;"></div>
                        </div>

                        <div style="margin-top: 20px;">
                            <h4>🧪 Test Scenarios</h4>
                            <div class="preset-buttons">
                                <button type="button" class="preset-btn" onclick="runTestScenario('happy-path')">Happy Path</button>
                                <button type="button" class="preset-btn" onclick="runTestScenario('error-cases')">Error Cases</button>
                                <button type="button" class="preset-btn" onclick="runTestScenario('edge-cases')">Edge Cases</button>
                                <button type="button" class="preset-btn" onclick="runTestScenario('performance')">Performance</button>
                            </div>
                            <div id="scenarioResults" style="margin-top: 15px;"></div>
                        </div>
                    </div>

                    <!-- Enhanced History Panel -->
                    <div class="history-panel">
                        <h2 class="panel-title">📋 Request History & Collections</h2>
                        <div style="margin-bottom: 15px;">
                            <button type="button" class="btn btn-success" onclick="saveCollection()">Save Collection</button>
                            <button type="button" class="btn btn-secondary" onclick="loadCollection()">Load Collection</button>
                            <button type="button" class="btn btn-secondary" onclick="exportHistory()">Export History</button>
                            <button type="button" class="btn btn-secondary" onclick="clearHistory()">Clear History</button>
                        </div>
                        <div id="historyContainer">
                            <p style="color: #666; text-align: center;">No requests sent yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Module and Initialization -->
    <script type="module">
        import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

        window.testChat = function() {
            const chatTriggerUrl = document.getElementById('chatTriggerUrl').value;
            if (!chatTriggerUrl) {
                alert('Please enter a Chat Trigger URL');
                return;
            }

            const container = document.getElementById('chatContainer');
            container.innerHTML = '';

            try {
                createChat({
                    webhookUrl: chatTriggerUrl,
                    container: container
                });
            } catch (e) {
                console.error('Error initializing chat:', e);
                alert('Error initializing chat: ' + e.message);
            }
        };
    </script>

    <script>
        let requestHistory = [];
        let sessionId = '';
        let environments = {
            dev: '',
            staging: '',
            production: ''
        };
        let performanceStats = {
            totalRequests: 0,
            totalResponseTime: 0,
            successfulRequests: 0,
            lastResponseSize: 0
        };

        // Rate limiting variables
        let loadTestRequestTracker = [];
        const RATE_LIMIT_WINDOW = 60000; // 1 minute in milliseconds
        const MAX_LOAD_TEST_REQUESTS = 50;

        // Sidebar resizing functionality
        let isResizing = false;

        document.addEventListener('DOMContentLoaded', function() {
            sessionId = generateSessionId();
            document.getElementById('sessionDisplay').textContent = sessionId;
            setDefaultHeaders();
            loadPreset('basic');
            loadEnvironments();
            initializeSidebarResize();
        });

        function initializeSidebarResize() {
            const resizeHandle = document.getElementById('resizeHandle');
            const sidebar = document.getElementById('sidebar');

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });

            function handleResize(e) {
                if (!isResizing) return;
                
                const newWidth = e.clientX;
                if (newWidth >= 300 && newWidth <= 600) {
                    sidebar.style.width = newWidth + 'px';
                }
            }

            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        function checkLoadTestRateLimit(requestCount) {
            const now = Date.now();
            
            // Remove requests older than 1 minute
            loadTestRequestTracker = loadTestRequestTracker.filter(timestamp => 
                now - timestamp < RATE_LIMIT_WINDOW
            );
            
            // Check if adding this many requests would exceed the limit
            if (loadTestRequestTracker.length + requestCount > MAX_LOAD_TEST_REQUESTS) {
                return false;
            }
            
            // Add current batch to tracker
            for (let i = 0; i < requestCount; i++) {
                loadTestRequestTracker.push(now);
            }
            
            return true;
        }

        // Generate session ID on page load
        function generateSessionId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 9);
            return `session_${timestamp}_${random}`;
        }

        function setDefaultHeaders() {
            const headerContainer = document.getElementById('headersContainer');
            headerContainer.innerHTML = `
                <div class="header-row">
                    <input type="text" placeholder="Header Name" class="header-name" value="Content-Type">
                    <input type="text" placeholder="Header Value" class="header-value" value="application/json">
                    <button type="button" class="btn btn-danger" onclick="removeHeader(this)">Remove</button>
                </div>
            `;
        }

        function addHeader() {
            const container = document.getElementById('headersContainer');
            const headerRow = document.createElement('div');
            headerRow.className = 'header-row';
            headerRow.innerHTML = `
                <input type="text" placeholder="Header Name" class="header-name">
                <input type="text" placeholder="Header Value" class="header-value">
                <button type="button" class="btn btn-danger" onclick="removeHeader(this)">Remove</button>
            `;
            container.appendChild(headerRow);
        }

        function removeHeader(button) {
            const container = document.getElementById('headersContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }

        function loadPreset(type) {
            const bodyTextarea = document.getElementById('requestBody');
            const presets = {
                basic: {
                    sessionId: sessionId,
                    message: "Hello n8n!",
                    timestamp: new Date().toISOString(),
                    test: true
                },
                user: {
                    sessionId: sessionId,
                    user: {
                        id: 123,
                        name: "John Doe",
                        email: "john@example.com",
                        role: "user"
                    },
                    action: "user_created",
                    timestamp: new Date().toISOString()
                },
                order: {
                    sessionId: sessionId,
                    order: {
                        id: "ORD-001",
                        customer: "Jane Smith",
                        items: [
                            { name: "Product A", quantity: 2, price: 29.99 },
                            { name: "Product B", quantity: 1, price: 15.50 }
                        ],
                        total: 75.48
                    },
                    event: "order_placed",
                    timestamp: new Date().toISOString()
                },
                webhook: {
                    sessionId: sessionId,
                    event: "webhook.triggered",
                    source: "external_system",
                    data: {
                        id: "evt_123456",
                        type: "payment.completed",
                        amount: 99.99,
                        currency: "USD",
                        metadata: {
                            customer_id: "cust_789",
                            invoice_id: "inv_456"
                        }
                    },
                    timestamp: new Date().toISOString()
                },
                empty: {
                    sessionId: sessionId
                }
            };

            if (presets[type]) {
                bodyTextarea.value = formatJsonIndustryStandard(presets[type]);
            }
        }

        function formatJson() {
            const textarea = document.getElementById('requestBody');
            try {
                const parsed = JSON.parse(textarea.value);
                textarea.value = formatJsonIndustryStandard(parsed);
            } catch (e) {
                alert('Invalid JSON format');
            }
        }

        function minifyJson() {
            const textarea = document.getElementById('requestBody');
            try {
                const parsed = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(parsed);
            } catch (e) {
                alert('Invalid JSON format');
            }
        }

        function validateJson() {
            const textarea = document.getElementById('requestBody');
            try {
                JSON.parse(textarea.value);
                alert('JSON is valid!');
            } catch (e) {
                alert('Invalid JSON: ' + e.message);
            }
        }

        function generateSchema() {
            const textarea = document.getElementById('requestBody');
            try {
                const data = JSON.parse(textarea.value);
                const schema = generateJsonSchema(data);
                document.getElementById('jsonSchema').value = JSON.stringify(schema, null, 2);
                alert('Schema generated! Check the Schema Validation section.');
            } catch (e) {
                alert('Invalid JSON format');
            }
        }

        function generateJsonSchema(obj) {
            if (obj === null) return { type: "null" };
            if (typeof obj === "boolean") return { type: "boolean" };
            if (typeof obj === "number") return { type: "number" };
            if (typeof obj === "string") return { type: "string" };
            if (Array.isArray(obj)) {
                return {
                    type: "array",
                    items: obj.length > 0 ? generateJsonSchema(obj[0]) : { type: "string" }
                };
            }
            if (typeof obj === "object") {
                const properties = {};
                const required = [];
                for (const key in obj) {
                    properties[key] = generateJsonSchema(obj[key]);
                    required.push(key);
                }
                return { type: "object", properties, required };
            }
            return { type: "string" };
        }

        // Environment Management
        function loadEnvironments() {
            const saved = JSON.parse(localStorage.getItem('n8n-environments') || '{}');
            environments = { ...environments, ...saved };
        }

        function saveEnvironments() {
            localStorage.setItem('n8n-environments', JSON.stringify(environments));
        }

        function manageEnvironments() {
            const envName = prompt('Environment name (dev/staging/production):');
            if (!envName) return;
            
            const envUrl = prompt(`Enter URL for ${envName} environment:`);
            if (!envUrl) return;
            
            environments[envName] = envUrl;
            saveEnvironments();
            
            // Update environment selector
            const select = document.getElementById('environmentSelect');
            const option = Array.from(select.options).find(opt => opt.value === envName);
            if (!option) {
                const newOption = new Option(envName.charAt(0).toUpperCase() + envName.slice(1), envName);
                select.add(newOption);
            }
            
            alert(`Environment ${envName} saved!`);
        }

        function buildUrl() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const webhookPath = document.getElementById('webhookPath').value.trim();
            
            if (!baseUrl) {
                alert('Please enter a base URL');
                return;
            }
            
            let fullUrl = baseUrl;
            if (webhookPath) {
                if (!webhookPath.startsWith('/')) {
                    fullUrl += '/';
                }
                fullUrl += webhookPath;
            }
            
            document.getElementById('webhookUrl').value = fullUrl;
        }

        async function testConnection() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            if (!baseUrl) {
                alert('Please enter a base URL');
                return;
            }

            try {
                document.getElementById('connectionStatus').textContent = 'Testing...';
                const response = await fetch(baseUrl + '/health', { method: 'GET' });
                document.getElementById('connectionStatus').textContent = response.ok ? 'Connected' : 'No Response';
            } catch (error) {
                document.getElementById('connectionStatus').textContent = 'Connection Failed';
            }
        }

        // Authentication
        function switchAuth(type) {
            document.querySelectorAll('.auth-type').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-fields').forEach(field => field.classList.remove('active'));
            
            document.querySelector(`[data-auth="${type}"]`).classList.add('active');
            document.getElementById(`auth${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
        }

        function getHeaders() {
            const headers = {};
            const headerRows = document.querySelectorAll('#headersContainer .header-row');
            
            headerRows.forEach(row => {
                const name = row.querySelector('.header-name').value.trim();
                const value = row.querySelector('.header-value').value.trim();
                if (name && value) {
                    headers[name] = value;
                }
            });

            // Add authentication headers
            const activeAuth = document.querySelector('.auth-type.active').dataset.auth;
            
            if (activeAuth === 'bearer') {
                const token = document.getElementById('bearerToken').value.trim();
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
            } else if (activeAuth === 'basic') {
                const username = document.getElementById('basicUsername').value.trim();
                const password = document.getElementById('basicPassword').value.trim();
                if (username && password) {
                    headers['Authorization'] = `Basic ${btoa(username + ':' + password)}`;
                }
            } else if (activeAuth === 'apikey') {
                const keyName = document.getElementById('apiKeyName').value.trim();
                const keyValue = document.getElementById('apiKeyValue').value.trim();
                if (keyName && keyValue) {
                    headers[keyName] = keyValue;
                }
            }
            
            return headers;
        }

        async function sendWebhook() {
            const url = document.getElementById('webhookUrl').value;
            const method = document.getElementById('httpMethod').value;
            const body = document.getElementById('requestBody').value;
            const headers = getHeaders();

            if (!url) {
                alert('Please enter a webhook URL');
                return;
            }

            // Show loading state
            showStatus('loading', 'Sending request...');
            
            const startTime = Date.now();

            try {
                const requestOptions = {
                    method: method,
                    headers: headers
                };

                if (method !== 'GET' && body.trim()) {
                    requestOptions.body = body;
                }

                const response = await fetch(url, requestOptions);
                const responseTime = Date.now() - startTime;
                
                let responseText = '';
                let isHtml = false;
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    try {
                        const jsonResponse = await response.json();
                        responseText = JSON.stringify(jsonResponse, null, 2);
                    } catch (e) {
                        responseText = await response.text();
                    }
                } else if (contentType && contentType.includes('text/html')) {
                    responseText = await response.text();
                    isHtml = true;
                } else {
                    responseText = await response.text();
                }

                const statusClass = response.ok ? 'success' : 'error';
                showStatus(statusClass, `${response.status} ${response.statusText} (${responseTime}ms)`);
                
                displayResponse(responseText, isHtml, contentType, response.headers, responseTime);

                // Update performance stats
                updatePerformanceStats(responseTime, response.ok, responseText.length);

                // Add to history
                addToHistory({
                    url: url,
                    method: method,
                    headers: headers,
                    body: body,
                    status: response.status,
                    statusText: response.statusText,
                    responseTime: responseTime,
                    timestamp: new Date(),
                    response: responseText,
                    responseHeaders: Object.fromEntries(response.headers.entries())
                });

            } catch (error) {
                const responseTime = Date.now() - startTime;
                showStatus('error', `Error: ${error.message} (${responseTime}ms)`);
                displayResponse(`Error: ${error.message}`, false, 'text/plain', new Headers(), responseTime);
                
                // Update performance stats
                updatePerformanceStats(responseTime, false, 0);
                
                // Add error to history
                addToHistory({
                    url: url,
                    method: method,
                    headers: headers,
                    body: body,
                    status: 'Error',
                    statusText: error.message,
                    responseTime: responseTime,
                    timestamp: new Date(),
                    response: `Error: ${error.message}`,
                    responseHeaders: {}
                });
            }
        }

        function updatePerformanceStats(responseTime, success, responseSize) {
            performanceStats.totalRequests++;
            performanceStats.totalResponseTime += responseTime;
            performanceStats.lastResponseSize = responseSize;
            
            if (success) {
                performanceStats.successfulRequests++;
            }

            // Update UI
            document.getElementById('totalRequests').textContent = performanceStats.totalRequests;
            document.getElementById('avgResponseTime').textContent = 
                Math.round(performanceStats.totalResponseTime / performanceStats.totalRequests) + 'ms';
            document.getElementById('successRate').textContent = 
                Math.round((performanceStats.successfulRequests / performanceStats.totalRequests) * 100) + '%';
            document.getElementById('lastResponseSize').textContent = formatBytes(responseSize);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + sizes[i];
        }

        function displayResponse(responseText, isHtml, contentType, responseHeaders, responseTime) {
            const responseTabs = document.getElementById('responseTabs');
            const formattedView = document.getElementById('formattedView');
            const rawView = document.getElementById('rawContent');
            const previewView = document.getElementById('previewView');
            const htmlPreview = document.getElementById('htmlPreview');
            const previewTab = document.querySelector('[data-tab="preview"]');
            const headersView = document.getElementById('headersContent');
            const analysisView = document.getElementById('analysisContent');

            responseTabs.style.display = 'flex';

            const normalizedResponse = normalizeLineEndings(responseText);

            // Try parsing JSON to check for nested content
            let parsedObject = null;
            let isValidJson = false;
            
            try {
                parsedObject = JSON.parse(normalizedResponse);
                isValidJson = true;
            } catch (_) {}

            let htmlCandidate = null;
            let shouldEnhanceJson = false;
            
            // Check for HTML content in JSON response
            if (parsedObject && typeof parsedObject === 'object') {
                if (parsedObject.data && typeof parsedObject.data === 'string' && parsedObject.data.trim().startsWith('<')) {
                    htmlCandidate = parsedObject.data.trim();
                    isHtml = true;
                    contentType = 'text/html';
                }
                // Check for output field that might contain code or HTML
                if (parsedObject.output && typeof parsedObject.output === 'string') {
                    const outputContent = parsedObject.output.trim();
                    if (outputContent.startsWith('<')) {
                        htmlCandidate = outputContent;
                        isHtml = true;
                        contentType = 'text/html';
                    }
                }
            } 
            // Check if it's a direct JSON array/object that should be enhanced for AI preview
            else if (Array.isArray(parsedObject) || (parsedObject && typeof parsedObject === 'object')) {
                shouldEnhanceJson = true;
            }
            else if (normalizedResponse.trim().startsWith('<!DOCTYPE html') || normalizedResponse.trim().startsWith('<html')) {
                htmlCandidate = normalizedResponse;
                isHtml = true;
                contentType = 'text/html';
            }

            if (isHtml && htmlCandidate) {
                previewTab.style.display = 'block';
                try {
                    const formatted = formatXml(htmlCandidate);
                    formattedView.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.4;">${escapeHtml(formatted)}</pre>`;
                } catch (e) {
                    formattedView.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.4;">${escapeHtml(htmlCandidate)}</pre>`;
                }
                htmlPreview.srcdoc = htmlCandidate;
                switchTab('preview');
            } else if (shouldEnhanceJson && parsedObject) {
                // Show preview for enhanced AI JSON responses
                previewTab.style.display = 'block';
                previewTab.textContent = 'AI Preview';
                
                // Generate enhanced HTML preview for AI responses
                const enhancedHtml = generateAIResponsePreview(parsedObject);
                htmlPreview.srcdoc = enhancedHtml;
                
                // Format JSON in formatted view
                try {
                    let jsonToFormat = parsedObject;
                    
                    // Special handling for nested JSON strings (like the "output" field)
                    if (jsonToFormat.output && typeof jsonToFormat.output === 'string') {
                        try {
                            // Try to parse the output field as JSON
                            const nestedJson = JSON.parse(jsonToFormat.output);
                            // Create a formatted object with the parsed nested JSON
                            const expandedJson = { ...jsonToFormat, output: nestedJson };
                            const formattedJson = JSON.stringify(expandedJson, null, 2);
                            
                            formattedView.innerHTML = `
                                <div style="margin-bottom: 10px;">
                                    <button onclick="toggleJsonExpansion()" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                        Toggle Nested JSON View
                                    </button>
                                </div>
                                <div id="expandedJsonView">
                                    <pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #333; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">${escapeHtml(formattedJson)}</pre>
                                </div>
                                <div id="originalJsonView" style="display: none;">
                                    <pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #333; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1976d2;">${escapeHtml(JSON.stringify(jsonToFormat, null, 2))}</pre>
                                </div>
                            `;
                        } catch (nestedError) {
                            // If nested parsing fails, just format the original
                            const formattedJson = JSON.stringify(jsonToFormat, null, 2);
                            formattedView.innerHTML = `<pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #333; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1976d2;">${escapeHtml(formattedJson)}</pre>`;
                        }
                    } else {
                        // Standard JSON formatting
                        const formattedJson = JSON.stringify(jsonToFormat, null, 2);
                        formattedView.innerHTML = `<pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #333; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1976d2;">${escapeHtml(formattedJson)}</pre>`;
                    }
                } catch (e) {
                    // If JSON parsing fails, display as formatted text
                    formattedView.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.4;">${escapeHtml(normalizedResponse)}</pre>`;
                }
                switchTab('preview');
            } else {
                previewTab.style.display = 'none';
                previewTab.textContent = 'HTML Preview';
                
                // Handle JSON responses with industry-standard formatting
                if (isValidJson || (contentType && contentType.includes('application/json'))) {
                    try {
                        let jsonToFormat = parsedObject || JSON.parse(normalizedResponse);
                        
                        // Special handling for nested JSON strings (like the "output" field)
                        if (jsonToFormat.output && typeof jsonToFormat.output === 'string') {
                            try {
                                // Try to parse the output field as JSON
                                const nestedJson = JSON.parse(jsonToFormat.output);
                                // Create a formatted object with the parsed nested JSON
                                const expandedJson = { ...jsonToFormat, output: nestedJson };
                                const formattedJson = JSON.stringify(expandedJson, null, 2);
                                
                                formattedView.innerHTML = `
                                    <div style="margin-bottom: 10px;">
                                        <button onclick="toggleJsonExpansion()" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">
                                            Toggle Nested JSON View
                                        </button>
                                    </div>
                                    <div id="expandedJsonView">
                                        <pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #333; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">${escapeHtml(formattedJson)}</pre>
                                    </div>
                                    <div id="originalJsonView" style="display: none;">
                                        <pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #333; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1976d2;">${escapeHtml(JSON.stringify(jsonToFormat, null, 2))}</pre>
                                    </div>
                                `;
                            } catch (nestedError) {
                                // If nested parsing fails, just format the original
                                const formattedJson = JSON.stringify(jsonToFormat, null, 2);
                                formattedView.innerHTML = `<pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #333; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1976d2;">${escapeHtml(formattedJson)}</pre>`;
                            }
                        } else {
                            // Standard JSON formatting
                            const formattedJson = JSON.stringify(jsonToFormat, null, 2);
                            formattedView.innerHTML = `<pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #333; background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #1976d2;">${escapeHtml(formattedJson)}</pre>`;
                        }
                    } catch (e) {
                        // If JSON parsing fails, display as formatted text
                        formattedView.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.4;">${escapeHtml(normalizedResponse)}</pre>`;
                    }
                } else {
                    // Handle plain text responses
                    formattedView.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.4;">${escapeHtml(normalizedResponse)}</pre>`;
                }
                switchTab('formatted');
            }

            // Display headers
            let headersText = '';
            if (responseHeaders) {
                for (const [key, value] of responseHeaders.entries()) {
                    headersText += `${key}: ${value}\n`;
                }
            }
            headersView.textContent = headersText;

            // Display analysis
            const analysis = analyzeResponse(normalizedResponse, responseTime, contentType, isValidJson);
            analysisView.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.4;">${escapeHtml(analysis)}</pre>`;

            rawView.textContent = normalizedResponse;
        }

        function generateAIResponsePreview(data) {
            // Generate professional AI-standard HTML preview
            let html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Response Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .ai-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #1976d2;
        }
        
        .ai-section h2 {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .ai-section h3 {
            color: #34495e;
            font-size: 1.2em;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .ai-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
        }
        
        .property-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            margin-bottom: 20px;
            align-items: start;
        }
        
        .property-label {
            font-weight: 600;
            color: #495057;
            padding: 8px 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .property-value {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.95em;
            line-height: 1.5;
        }
        
        .constraints-list, .examples-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .constraints-list ul, .examples-list ul {
            list-style: none;
            padding: 0;
        }
        
        .constraints-list li, .examples-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            position: relative;
            padding-left: 25px;
        }
        
        .constraints-list li:before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
        }
        
        .examples-list li:before {
            content: '→';
            position: absolute;
            left: 0;
            color: #1976d2;
            font-weight: bold;
        }
        
        .json-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin-top: 15px;
            line-height: 1.4;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #1976d2;
            color: white;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .ideas-container {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        .idea-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .idea-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .timestamp {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9em;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 12px;
            }
            
            .content {
                padding: 20px;
            }
            
            .property-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Response Preview</h1>
            <p>Professional AI Content Visualization</p>
        </div>
        
        <div class="content">`;

            // Handle array responses
            if (Array.isArray(data)) {
                data.forEach((item, index) => {
                    html += `<div class="ai-section">`;
                    html += `<div class="badge">Response ${index + 1}</div>`;
                    html += generateItemContent(item);
                    html += `</div>`;
                });
            } else if (typeof data === 'object') {
                html += `<div class="ai-section">`;
                html += generateItemContent(data);
                html += `</div>`;
            }

            html += `
        </div>
        
        <div class="timestamp">
            Generated on ${new Date().toLocaleString()} | n8n Webhook Tester Pro
        </div>
    </div>
</body>
</html>`;

            return html;
        }

        function generateItemContent(item) {
            let content = '';
            
            // Handle different AI response patterns
            if (item.Context || item.Role || item.Function) {
                // AI Prompt/Content Creator pattern
                content += `<h2>🎯 AI Content Creator Configuration</h2>`;
                
                if (item.Context) {
                    content += `
                        <div class="property-grid">
                            <div class="property-label">Context</div>
                            <div class="property-value">${item.Context}</div>
                        </div>`;
                }
                
                if (item.Role) {
                    content += `
                        <div class="property-grid">
                            <div class="property-label">Role</div>
                            <div class="property-value">${item.Role}</div>
                        </div>`;
                }
                
                if (item.Function) {
                    content += `
                        <div class="property-grid">
                            <div class="property-label">Function</div>
                            <div class="property-value">${item.Function}</div>
                        </div>`;
                }
                
                if (item.Objective || item['Output Format']) {
                    content += `<h3>📋 Configuration Details</h3>`;
                    
                    if (item.Objective) {
                        content += `
                            <div class="property-grid">
                                <div class="property-label">Objective</div>
                                <div class="property-value">${item.Objective}</div>
                            </div>`;
                    }
                    
                    if (item['Output Format']) {
                        content += `
                            <div class="property-grid">
                                <div class="property-label">Output Format</div>
                                <div class="property-value">${item['Output Format']}</div>
                            </div>`;
                    }
                }
                
                if (item.Constraints && Array.isArray(item.Constraints)) {
                    content += `
                        <h3>⚡ Constraints</h3>
                        <div class="constraints-list">
                            <ul>
                                ${item.Constraints.map(constraint => `<li>${constraint}</li>`).join('')}
                            </ul>
                        </div>`;
                }
                
                if (item.Examples && Array.isArray(item.Examples)) {
                    content += `<h3>💡 Examples</h3>`;
                    item.Examples.forEach((example, idx) => {
                        if (example.ideas && Array.isArray(example.ideas)) {
                            content += `
                                <div class="ai-content">
                                    <h4>Example Set ${idx + 1}: Home Decor Ideas</h4>
                                    <div class="ideas-container">
                                        ${example.ideas.map(idea => `
                                            <div class="idea-card">
                                                <h4>💡 ${idea}</h4>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>`;
                        } else {
                            content += `<div class="json-code">${JSON.stringify(example, null, 2)}</div>`;
                        }
                    });
                }
            } else {
                // Generic object handling
                content += `<h2>📄 Data Response</h2>`;
                content += `<div class="json-code">${JSON.stringify(item, null, 2)}</div>`;
            }
            
            return content;
        }

        // Add this new function to toggle between views
        window.toggleJsonExpansion = function() {
            const expandedView = document.getElementById('expandedJsonView');
            const originalView = document.getElementById('originalJsonView');
            
            if (expandedView && originalView) {
                if (expandedView.style.display === 'none') {
                    expandedView.style.display = 'block';
                    originalView.style.display = 'none';
                } else {
                    expandedView.style.display = 'none';
                    originalView.style.display = 'block';
                }
            }
        };

        function formatJsonIndustryStandard(obj) {
            // Handle string that contains JSON (like the output field)
            if (typeof obj === 'object' && obj.output && typeof obj.output === 'string') {
                try {
                    // Try to parse the output field as JSON
                    const parsedOutput = JSON.parse(obj.output);
                    // Create a new object with parsed output
                    const newObj = { ...obj, output: parsedOutput };
                    return JSON.stringify(newObj, null, 2);
                } catch (e) {
                    // If output is not JSON, keep it as string but format the main object
                    return JSON.stringify(obj, null, 2);
                }
            }
            
            // Standard JSON formatting with proper indentation and spacing
            const jsonString = JSON.stringify(obj, null, 2);
            
            // Apply additional formatting rules for better readability
            return jsonString
                .replace(/{\s*\n/g, '{\n')  // Ensure proper opening brace formatting
                .replace(/\n\s*}/g, '\n}')  // Ensure proper closing brace formatting
                .replace(/\[\s*\n/g, '[\n')  // Ensure proper opening bracket formatting
                .replace(/\n\s*\]/g, '\n]')  // Ensure proper closing bracket formatting
                .replace(/,\s*\n/g, ',\n')   // Ensure proper comma formatting
                .replace(/:\s*/g, ': ')      // Ensure space after colons
                .replace(/\n {2}/g, '\n  ')  // Standardize to 2-space indentation
                .replace(/\n {4}/g, '\n    ') // 4 spaces for nested levels
                .replace(/\n {6}/g, '\n      ') // 6 spaces for deeply nested levels
                .replace(/\n {8}/g, '\n        '); // 8 spaces for very deep nesting
        }

        function analyzeResponse(responseText, responseTime, contentType, isValidJson) {
            let analysis = `Response Analysis\n================\n\n`;
            
            analysis += `Response Time: ${responseTime}ms\n`;
            analysis += `Content Type: ${contentType || 'Unknown'}\n`;
            analysis += `Response Size: ${formatBytes(responseText.length)}\n`;
            analysis += `Valid JSON: ${isValidJson ? 'Yes' : 'No'}\n\n`;

            if (isValidJson) {
                try {
                    const parsed = JSON.parse(responseText);
                    analysis += `JSON Structure Analysis:\n`;
                    analysis += `${'-'.repeat(25)}\n`;
                    analysis += `Root Type: ${Array.isArray(parsed) ? 'Array' : typeof parsed}\n`;
                    
                    if (typeof parsed === 'object' && !Array.isArray(parsed)) {
                        analysis += `Properties Count: ${Object.keys(parsed).length}\n`;
                        analysis += `Property Names: ${Object.keys(parsed).join(', ')}\n\n`;
                        
                        // Analyze each property
                        Object.entries(parsed).forEach(([key, value]) => {
                            const valueType = Array.isArray(value) ? 'array' : typeof value;
                            analysis += `  ${key}: ${valueType}`;
                            
                            if (valueType === 'string') {
                                analysis += ` (${value.length} chars)`;
                                // Check if string contains code patterns
                                if (value.includes('function') || value.includes('const ') || value.includes('```')) {
                                    analysis += ` [Contains code]`;
                                }
                                if (value.includes('<') && value.includes('>')) {
                                    analysis += ` [Contains markup]`;
                                }
                            } else if (valueType === 'array') {
                                analysis += ` (${value.length} items)`;
                            } else if (valueType === 'object' && value !== null) {
                                analysis += ` (${Object.keys(value).length} properties)`;
                            }
                            analysis += '\n';
                        });
                    }
                    
                    if (Array.isArray(parsed)) {
                        analysis += `Array Length: ${parsed.length}\n`;
                        if (parsed.length > 0) {
                            analysis += `First Item Type: ${Array.isArray(parsed[0]) ? 'array' : typeof parsed[0]}\n`;
                        }
                    }

                    // Check for common n8n response patterns
                    if (parsed.data !== undefined) {
                        analysis += `\nn8n Workflow Response Pattern Detected:\n`;
                        analysis += `${'-'.repeat(40)}\n`;
                        analysis += `Contains 'data' property: Yes\n`;
                        if (Array.isArray(parsed.data)) {
                            analysis += `Data Type: Array with ${parsed.data.length} items\n`;
                        } else {
                            analysis += `Data Type: ${typeof parsed.data}\n`;
                        }
                    }

                    if (parsed.output !== undefined) {
                        analysis += `\nCode/Output Response Detected:\n`;
                        analysis += `${'-'.repeat(30)}\n`;
                        analysis += `Contains 'output' property: Yes\n`;
                        analysis += `Output Type: ${typeof parsed.output}\n`;
                        if (typeof parsed.output === 'string') {
                            analysis += `Output Length: ${parsed.output.length} characters\n`;
                            if (parsed.output.includes('```')) {
                                analysis += `Contains code blocks: Yes\n`;
                                const codeBlocks = parsed.output.match(/```[\s\S]*?```/g);
                                if (codeBlocks) {
                                    analysis += `Code blocks found: ${codeBlocks.length}\n`;
                                    codeBlocks.forEach((block, i) => {
                                        const language = block.match(/```(\w+)/);
                                        analysis += `  Block ${i + 1}: ${language ? language[1] : 'unknown language'}\n`;
                                    });
                                }
                            }
                        }
                    }

                    if (parsed.error) {
                        analysis += `\nError Response Detected:\n`;
                        analysis += `${'-'.repeat(25)}\n`;
                        analysis += `Error Message: ${parsed.error}\n`;
                    }

                    if (parsed.success !== undefined) {
                        analysis += `\nStatus Indicator Found:\n`;
                        analysis += `${'-'.repeat(22)}\n`;
                        analysis += `Success: ${parsed.success}\n`;
                    }

                    // Check for webhook/event patterns
                    if (parsed.event || parsed.trigger || parsed.webhook) {
                        analysis += `\nWebhook/Event Pattern Detected:\n`;
                        analysis += `${'-'.repeat(32)}\n`;
                        if (parsed.event) analysis += `Event: ${parsed.event}\n`;
                        if (parsed.trigger) analysis += `Trigger: ${parsed.trigger}\n`;
                        if (parsed.webhook) analysis += `Webhook: ${parsed.webhook}\n`;
                    }

                } catch (e) {
                    analysis += `JSON parsing error: ${e.message}\n`;
                }
            } else {
                analysis += `Non-JSON Response Analysis:\n`;
                analysis += `${'-'.repeat(27)}\n`;
                analysis += `Text Length: ${responseText.length} characters\n`;
                analysis += `Line Count: ${responseText.split('\n').length}\n`;
                
                // Check for common response patterns
                if (responseText.toLowerCase().includes('error')) {
                    analysis += `Contains error indicators: Yes\n`;
                }
                if (responseText.includes('<html') || responseText.includes('<!DOCTYPE')) {
                    analysis += `HTML document detected: Yes\n`;
                }
                if (responseText.includes('success') || responseText.includes('ok')) {
                    analysis += `Contains success indicators: Yes\n`;
                }
            }

            // Performance assessment
            analysis += `\nPerformance Assessment:\n`;
            analysis += `${'-'.repeat(23)}\n`;
            if (responseTime < 100) {
                analysis += `Response Speed: Excellent (< 100ms)\n`;
            } else if (responseTime < 500) {
                analysis += `Response Speed: Good (< 500ms)\n`;
            } else if (responseTime < 1000) {
                analysis += `Response Speed: Acceptable (< 1s)\n`;
            } else {
                analysis += `Response Speed: Slow (> 1s) - Consider optimization\n`;
            }

            const sizeKB = responseText.length / 1024;
            if (sizeKB < 1) {
                analysis += `Response Size: Small (< 1KB)\n`;
            } else if (sizeKB < 10) {
                analysis += `Response Size: Medium (< 10KB)\n`;
            } else if (sizeKB < 100) {
                analysis += `Response Size: Large (< 100KB)\n`;
            } else {
                analysis += `Response Size: Very Large (> 100KB) - Consider pagination\n`;
            }

            return analysis;
        }

        function normalizeLineEndings(text) {
            return text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        }

        function formatXml(xml) {
            const PADDING = '  ';
            xml = normalizeLineEndings(xml);
            const reg = /(>)(<)(\/*)/g;
            xml = xml.replace(reg, '$1\n$2$3');
            
            let pad = 0;
            const lines = xml.split('\n');
            
            return lines.map((line) => {
                let indent = 0;
                const trimmedLine = line.trim();
                
                if (trimmedLine.length === 0) {
                    return '';
                }
                
                if (trimmedLine.match(/.+<\/\w[^>]*>$/)) {
                    indent = 0;
                } else if (trimmedLine.match(/^<\/\w/)) {
                    if (pad > 0) {
                        pad -= 1;
                    }
                } else if (trimmedLine.match(/^<\w[^>]*[^\/]>.*$/)) {
                    indent = 1;
                } else {
                    indent = 0;
                }
                
                const padding = PADDING.repeat(pad);
                pad += indent;
                
                return padding + trimmedLine;
            }).join('\n');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.response-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('.response-view').forEach(view => {
                view.classList.remove('active');
            });
            
            if (tabName === 'formatted') {
                document.getElementById('formattedView').classList.add('active');
            } else if (tabName === 'raw') {
                document.getElementById('rawView').classList.add('active');
            } else if (tabName === 'preview') {
                document.getElementById('previewView').classList.add('active');
            } else if (tabName === 'headers') {
                document.getElementById('headersView').classList.add('active');
            } else if (tabName === 'analysis') {
                document.getElementById('analysisView').classList.add('active');
            }
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('responseStatus');
            statusDiv.innerHTML = '';
            
            const statusSpan = document.createElement('span');
            statusSpan.className = `status-indicator status-${type}`;
            
            if (type === 'loading') {
                statusSpan.innerHTML = `<span class="loading-spinner"></span>${message}`;
            } else {
                statusSpan.textContent = message;
            }
            
            statusDiv.appendChild(statusSpan);
        }

        // Load Testing with Rate Limiting
        async function startLoadTest() {
            const requestCount = parseInt(document.getElementById('requestCount').value);
            const requestDelay = parseInt(document.getElementById('requestDelay').value);
            const concurrent = parseInt(document.getElementById('concurrent').value);

            if (!document.getElementById('webhookUrl').value) {
                alert('Please enter a webhook URL');
                return;
            }

            // Check rate limit for load testing
            if (!checkLoadTestRateLimit(requestCount)) {
                const currentRequests = loadTestRequestTracker.length;
                const remainingTime = Math.ceil((loadTestRequestTracker[0] + RATE_LIMIT_WINDOW - Date.now()) / 1000);
                alert(`Rate limit exceeded. You have made ${currentRequests} requests in the last minute. Maximum is ${MAX_LOAD_TEST_REQUESTS} requests per minute. Please wait ${remainingTime} seconds.`);
                return;
            }

            const results = [];
            let completed = 0;

            showStatus('loading', `Running load test: 0/${requestCount} requests...`);

            for (let batch = 0; batch < Math.ceil(requestCount / concurrent); batch++) {
                const batchPromises = [];
                const batchSize = Math.min(concurrent, requestCount - batch * concurrent);

                for (let i = 0; i < batchSize; i++) {
                    batchPromises.push(
                        (async () => {
                            const startTime = Date.now();
                            try {
                                const response = await fetch(document.getElementById('webhookUrl').value, {
                                    method: document.getElementById('httpMethod').value,
                                    headers: getHeaders(),
                                    body: document.getElementById('httpMethod').value !== 'GET' 
                                        ? document.getElementById('requestBody').value : undefined
                                });
                                const responseTime = Date.now() - startTime;
                                completed++;
                                showStatus('loading', `Running load test: ${completed}/${requestCount} requests...`);
                                return { success: response.ok, responseTime, status: response.status };
                            } catch (error) {
                                completed++;
                                showStatus('loading', `Running load test: ${completed}/${requestCount} requests...`);
                                return { success: false, responseTime: Date.now() - startTime, error: error.message };
                            }
                        })()
                    );
                }

                const batchResults = await Promise.all(batchPromises);
                results.push(...batchResults);

                if (batch < Math.ceil(requestCount / concurrent) - 1) {
                    await new Promise(resolve => setTimeout(resolve, requestDelay));
                }
            }

            // Display results
            const successCount = results.filter(r => r.success).length;
            const avgResponseTime = results.reduce((sum, r) => sum + r.responseTime, 0) / results.length;
            const successRate = (successCount / results.length) * 100;

            showStatus('success', `Load test completed: ${successRate.toFixed(1)}% success rate, ${avgResponseTime.toFixed(0)}ms avg response time`);
            
            document.getElementById('scenarioResults').innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef; margin-top: 10px;">
                    <h5>Load Test Results</h5>
                    <p><strong>Total Requests:</strong> ${requestCount}</p>
                    <p><strong>Successful:</strong> ${successCount} (${successRate.toFixed(1)}%)</p>
                    <p><strong>Failed:</strong> ${requestCount - successCount}</p>
                    <p><strong>Average Response Time:</strong> ${avgResponseTime.toFixed(0)}ms</p>
                    <p><strong>Min Response Time:</strong> ${Math.min(...results.map(r => r.responseTime))}ms</p>
                    <p><strong>Max Response Time:</strong> ${Math.max(...results.map(r => r.responseTime))}ms</p>
                </div>
            `;
        }

        // Schema Validation
        function validateAgainstSchema() {
            try {
                const schema = JSON.parse(document.getElementById('jsonSchema').value);
                const data = JSON.parse(document.getElementById('requestBody').value);
                
                const validation = validateJsonSchema(data, schema);
                const resultsDiv = document.getElementById('validationResults');
                
                if (validation.valid) {
                    resultsDiv.innerHTML = `<div style="color: #28a745; padding: 10px; background: #d4edda; border-radius: 4px;">✅ Validation passed!</div>`;
                } else {
                    resultsDiv.innerHTML = `<div style="color: #dc3545; padding: 10px; background: #f8d7da; border-radius: 4px;">❌ Validation failed:<br>${validation.errors.join('<br>')}</div>`;
                }
            } catch (e) {
                document.getElementById('validationResults').innerHTML = `<div style="color: #dc3545; padding: 10px; background: #f8d7da; border-radius: 4px;">Error: ${e.message}</div>`;
            }
        }

        function validateJsonSchema(data, schema) {
            const errors = [];
            
            function validate(value, schemaObj, path = '') {
                if (schemaObj.type) {
                    const actualType = Array.isArray(value) ? 'array' : typeof value;
                    if (actualType !== schemaObj.type) {
                        errors.push(`${path}: Expected ${schemaObj.type}, got ${actualType}`);
                    }
                }
                
                if (schemaObj.type === 'object' && schemaObj.properties) {
                    for (const prop in schemaObj.properties) {
                        if (value[prop] !== undefined) {
                            validate(value[prop], schemaObj.properties[prop], `${path}.${prop}`);
                        }
                    }
                    
                    if (schemaObj.required) {
                        for (const requiredProp of schemaObj.required) {
                            if (value[requiredProp] === undefined) {
                                errors.push(`${path}: Missing required property '${requiredProp}'`);
                            }
                        }
                    }
                }
                
                if (schemaObj.type === 'array' && schemaObj.items && Array.isArray(value)) {
                    value.forEach((item, index) => {
                        validate(item, schemaObj.items, `${path}[${index}]`);
                    });
                }
            }
            
            validate(data, schema);
            return { valid: errors.length === 0, errors };
        }

        function generateSampleData() {
            const schemaTextarea = document.getElementById('jsonSchema');
            const requestBodyTextarea = document.getElementById('requestBody');
            
            try {
                let schemaValue = schemaTextarea.value.trim();
                
                // If no schema is provided, use a default one
                if (!schemaValue) {
                    schemaValue = JSON.stringify({
                        "type": "object",
                        "properties": {
                            "name": {"type": "string"},
                            "age": {"type": "number"},
                            "email": {"type": "string"},
                            "active": {"type": "boolean"},
                            "tags": {
                                "type": "array",
                                "items": {"type": "string"}
                            },
                            "address": {
                                "type": "object",
                                "properties": {
                                    "street": {"type": "string"},
                                    "city": {"type": "string"},
                                    "zipCode": {"type": "string"}
                                }
                            }
                        },
                        "required": ["name", "email"]
                    }, null, 2);
                    
                    schemaTextarea.value = schemaValue;
                }
                
                const schema = JSON.parse(schemaValue);
                const sample = generateSampleFromSchema(schema);
                requestBodyTextarea.value = formatJsonIndustryStandard(sample);
                
                alert('Sample JSON generated successfully!');
            } catch (e) {
                alert('Invalid schema format: ' + e.message);
            }
        }

        function generateSampleFromSchema(schema) {
            // Handle different schema types
            if (!schema || typeof schema !== 'object') {
                return 'unknown';
            }
            
            if (schema.type === 'string') {
                if (schema.format === 'email') return 'user@example.com';
                if (schema.format === 'date') return '2024-01-01';
                if (schema.format === 'date-time') return new Date().toISOString();
                if (schema.format === 'uri') return 'https://example.com';
                return schema.example || 'sample string';
            }
            
            if (schema.type === 'number' || schema.type === 'integer') {
                if (schema.minimum !== undefined) return schema.minimum;
                if (schema.example !== undefined) return schema.example;
                return schema.type === 'integer' ? 42 : 42.5;
            }
            
            if (schema.type === 'boolean') {
                return schema.example !== undefined ? schema.example : true;
            }
            
            if (schema.type === 'null') {
                return null;
            }
            
            if (schema.type === 'array') {
                const items = schema.items || { type: 'string' };
                const minItems = schema.minItems || 1;
                const maxItems = Math.min(schema.maxItems || 3, 5); // Limit to max 5 items
                const itemCount = Math.max(minItems, Math.min(maxItems, 2));
                
                const result = [];
                for (let i = 0; i < itemCount; i++) {
                    result.push(generateSampleFromSchema(items));
                }
                return result;
            }
            
            if (schema.type === 'object') {
                const obj = {};
                
                if (schema.properties) {
                    // Add required properties first
                    if (schema.required && Array.isArray(schema.required)) {
                        schema.required.forEach(prop => {
                            if (schema.properties[prop]) {
                                obj[prop] = generateSampleFromSchema(schema.properties[prop]);
                            }
                        });
                    }
                    
                    // Add optional properties (up to 3 additional ones)
                    const optionalProps = Object.keys(schema.properties).filter(prop => 
                        !schema.required || !schema.required.includes(prop)
                    ).slice(0, 3);
                    
                    optionalProps.forEach(prop => {
                        obj[prop] = generateSampleFromSchema(schema.properties[prop]);
                    });
                }
                
                return obj;
            }
            
            // Handle oneOf, anyOf, allOf
            if (schema.oneOf && Array.isArray(schema.oneOf)) {
                return generateSampleFromSchema(schema.oneOf[0]);
            }
            
            if (schema.anyOf && Array.isArray(schema.anyOf)) {
                return generateSampleFromSchema(schema.anyOf[0]);
            }
            
            if (schema.allOf && Array.isArray(schema.allOf)) {
                // Merge all schemas (simplified approach)
                let merged = { type: 'object', properties: {} };
                schema.allOf.forEach(subSchema => {
                    if (subSchema.properties) {
                        merged.properties = { ...merged.properties, ...subSchema.properties };
                    }
                });
                return generateSampleFromSchema(merged);
            }
            
            // Handle enum
            if (schema.enum && Array.isArray(schema.enum)) {
                return schema.enum[0];
            }
            
            // Fallback
            return schema.example || 'sample value';
        }

        // Test Scenarios
        async function runTestScenario(scenario) {
            const resultsDiv = document.getElementById('scenarioResults');
            resultsDiv.innerHTML = '<div style="color: #0c5460; padding: 10px; background: #d1ecf1; border-radius: 4px;">Running test scenario...</div>';

            const scenarios = {
                'happy-path': async () => {
                    const tests = [
                        { name: 'Valid JSON Request', body: { sessionId: sessionId, test: 'happy-path', status: 'success' } },
                        { name: 'Basic Auth Test', headers: { 'Authorization': 'Bearer test-token' } },
                        { name: 'Content-Type Test', headers: { 'Content-Type': 'application/json' } }
                    ];
                    return await runTests(tests);
                },
                'error-cases': async () => {
                    const tests = [
                        { name: 'Invalid JSON', body: '{ invalid json }', expectError: true },
                        { name: 'Missing Required Field', body: { incomplete: true } },
                        { name: 'Wrong Content-Type', headers: { 'Content-Type': 'text/plain' } }
                    ];
                    return await runTests(tests);
                },
                'edge-cases': async () => {
                    const tests = [
                        { name: 'Empty Body', body: {} },
                        { name: 'Large Payload', body: { data: 'x'.repeat(1000), sessionId: sessionId } },
                        { name: 'Special Characters', body: { text: '!@#$%^&*()_+{}|:"<>?[]\\;\',./', sessionId: sessionId } }
                    ];
                    return await runTests(tests);
                },
                'performance': async () => {
                    const startTime = Date.now();
                    const promises = [];
                    
                    for (let i = 0; i < 5; i++) {
                        promises.push(sendTestRequest({ sessionId: sessionId, test: `performance-${i}` }));
                    }
                    
                    const results = await Promise.all(promises);
                    const totalTime = Date.now() - startTime;
                    const avgTime = results.reduce((sum, r) => sum + r.responseTime, 0) / results.length;
                    
                    return {
                        summary: `Performance Test: 5 concurrent requests in ${totalTime}ms (avg: ${avgTime.toFixed(0)}ms)`,
                        details: results.map((r, i) => `Request ${i + 1}: ${r.responseTime}ms (${r.success ? 'Success' : 'Failed'})`)
                    };
                }
            };

            try {
                const result = await scenarios[scenario]();
                displayScenarioResults(result, scenario);
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: #dc3545; padding: 10px; background: #f8d7da; border-radius: 4px;">Error running scenario: ${error.message}</div>`;
            }
        }

        async function runTests(tests) {
            const results = [];
            
            for (const test of tests) {
                try {
                    const result = await sendTestRequest(test.body, test.headers);
                    results.push({
                        name: test.name,
                        success: test.expectError ? !result.success : result.success,
                        responseTime: result.responseTime,
                        details: result.details
                    });
                } catch (error) {
                    results.push({
                        name: test.name,
                        success: test.expectError || false,
                        responseTime: 0,
                        details: error.message
                    });
                }
            }
            
            return {
                summary: `${results.filter(r => r.success).length}/${results.length} tests passed`,
                details: results.map(r => `${r.success ? '✅' : '❌'} ${r.name}: ${r.responseTime}ms`)
            };
        }

        async function sendTestRequest(body, headers = {}) {
            const url = document.getElementById('webhookUrl').value;
            if (!url) {
                throw new Error('No webhook URL configured');
            }

            const requestHeaders = { ...getHeaders(), ...headers };
            const startTime = Date.now();

            try {
                const response = await fetch(url, {
                    method: document.getElementById('httpMethod').value,
                    headers: requestHeaders,
                    body: typeof body === 'string' ? body : JSON.stringify(body)
                });

                const responseTime = Date.now() - startTime;
                const responseText = await response.text();

                return {
                    success: response.ok,
                    responseTime,
                    status: response.status,
                    details: responseText.substring(0, 100) + (responseText.length > 100 ? '...' : '')
                };
            } catch (error) {
                return {
                    success: false,
                    responseTime: Date.now() - startTime,
                    details: error.message
                };
            }
        }

        function displayScenarioResults(result, scenario) {
            const resultsDiv = document.getElementById('scenarioResults');
            resultsDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef; margin-top: 10px;">
                    <h5>${scenario.charAt(0).toUpperCase() + scenario.slice(1).replace('-', ' ')} Test Results</h5>
                    <p><strong>Summary:</strong> ${result.summary}</p>
                    <div style="margin-top: 10px;">
                        ${result.details.map(detail => `<div style="font-family: monospace; font-size: 12px; margin: 2px 0;">${detail}</div>`).join('')}
                    </div>
                </div>
            `;
        }

        // Export Functions
        function exportPostman() {
            const url = document.getElementById('webhookUrl').value;
            const method = document.getElementById('httpMethod').value;
            const headers = getHeaders();
            const body = document.getElementById('requestBody').value;

            const postmanCollection = {
                info: {
                    name: "n8n Webhook Test",
                    schema: "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
                },
                item: [{
                    name: "n8n Webhook Request",
                    request: {
                        method: method,
                        header: Object.entries(headers).map(([key, value]) => ({ key, value })),
                        body: method !== 'GET' ? {
                            mode: "raw",
                            raw: body,
                            options: {
                                raw: {
                                    language: "json"
                                }
                            }
                        } : undefined,
                        url: {
                            raw: url,
                            protocol: url.split(':')[0],
                            host: [url.split('//')[1]?.split('/')[0]],
                            path: url.split('//')[1]?.split('/').slice(1) || []
                        }
                    }
                }]
            };

            downloadFile(JSON.stringify(postmanCollection, null, 2), 'n8n-webhook-test.postman_collection.json', 'application/json');
        }

        function saveCollection() {
            const collection = {
                name: prompt('Collection name:') || 'My Collection',
                timestamp: new Date().toISOString(),
                url: document.getElementById('webhookUrl').value,
                method: document.getElementById('httpMethod').value,
                headers: getHeaders(),
                body: document.getElementById('requestBody').value,
                auth: {
                    type: document.querySelector('.auth-type.active').dataset.auth,
                    bearerToken: document.getElementById('bearerToken').value,
                    basicUsername: document.getElementById('basicUsername').value,
                    basicPassword: document.getElementById('basicPassword').value,
                    apiKeyName: document.getElementById('apiKeyName').value,
                    apiKeyValue: document.getElementById('apiKeyValue').value
                }
            };

            const collections = JSON.parse(localStorage.getItem('n8n-collections') || '[]');
            collections.push(collection);
            localStorage.setItem('n8n-collections', JSON.stringify(collections));
            
            alert('Collection saved!');
        }

        function loadCollection() {
            const collections = JSON.parse(localStorage.getItem('n8n-collections') || '[]');
            if (collections.length === 0) {
                alert('No saved collections found');
                return;
            }

            const collectionNames = collections.map((c, i) => `${i + 1}. ${c.name} (${new Date(c.timestamp).toLocaleDateString()})`);
            const choice = prompt('Select collection:\n' + collectionNames.join('\n') + '\n\nEnter number:');
            
            const index = parseInt(choice) - 1;
            if (index >= 0 && index < collections.length) {
                const collection = collections[index];
                
                document.getElementById('webhookUrl').value = collection.url;
                document.getElementById('httpMethod').value = collection.method;
                document.getElementById('requestBody').value = collection.body;
                
                // Load auth
                if (collection.auth) {
                    switchAuth(collection.auth.type);
                    document.getElementById('bearerToken').value = collection.auth.bearerToken || '';
                    document.getElementById('basicUsername').value = collection.auth.basicUsername || '';
                    document.getElementById('basicPassword').value = collection.auth.basicPassword || '';
                    document.getElementById('apiKeyName').value = collection.auth.apiKeyName || '';
                    document.getElementById('apiKeyValue').value = collection.auth.apiKeyValue || '';
                }
                
                // Load headers
                const container = document.getElementById('headersContainer');
                container.innerHTML = '';
                Object.entries(collection.headers || {}).forEach(([name, value]) => {
                    const headerRow = document.createElement('div');
                    headerRow.className = 'header-row';
                    headerRow.innerHTML = `
                        <input type="text" placeholder="Header Name" class="header-name" value="${name}">
                        <input type="text" placeholder="Header Value" class="header-value" value="${value}">
                        <button type="button" class="btn btn-danger" onclick="removeHeader(this)">Remove</button>
                    `;
                    container.appendChild(headerRow);
                });
                
                alert('Collection loaded!');
            }
        }

        function exportHistory() {
            if (requestHistory.length === 0) {
                alert('No history to export');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                sessionId: sessionId,
                history: requestHistory,
                performanceStats: performanceStats
            };

            downloadFile(JSON.stringify(exportData, null, 2), `n8n-webhook-history-${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function addToHistory(request) {
            requestHistory.unshift(request);
            if (requestHistory.length > 50) {
                requestHistory.pop();
            }
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('historyContainer');
            
            if (requestHistory.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No requests sent yet.</p>';
                return;
            }

            container.innerHTML = requestHistory.map((req, index) => {
                const statusClass = req.status === 'Error' ? 'status-error' : (req.status >= 200 && req.status < 300 ? 'status-success' : 'status-error');
                return `
                    <div class="history-item" onclick="loadFromHistory(${index})">
                        <div class="history-meta">${req.timestamp.toLocaleString()} | ${req.responseTime}ms</div>
                        <div class="history-url">${req.method} ${req.url}</div>
                        <div class="history-status ${statusClass}">
                            ${req.status} ${req.statusText}
                            ${req.responseHeaders && req.responseHeaders['content-type'] ? ` | ${req.responseHeaders['content-type'].split(';')[0]}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadFromHistory(index) {
            const req = requestHistory[index];
            document.getElementById('webhookUrl').value = req.url;
            document.getElementById('httpMethod').value = req.method;
            document.getElementById('requestBody').value = req.body;
            
            // Determine if response is HTML and display accordingly
            const isHtmlResponse = req.response.trim().startsWith('<') && req.response.includes('<html');
            const contentType = req.responseHeaders && req.responseHeaders['content-type'] ? req.responseHeaders['content-type'] : (isHtmlResponse ? 'text/html' : 'application/json');
            displayResponse(req.response, isHtmlResponse, contentType, new Headers(Object.entries(req.responseHeaders || {})), req.responseTime);
            
            // Load headers
            const container = document.getElementById('headersContainer');
            container.innerHTML = '';
            
            Object.entries(req.headers).forEach(([name, value]) => {
                const headerRow = document.createElement('div');
                headerRow.className = 'header-row';
                headerRow.innerHTML = `
                    <input type="text" placeholder="Header Name" class="header-name" value="${name}">
                    <input type="text" placeholder="Header Value" class="header-value" value="${value}">
                    <button type="button" class="btn btn-danger" onclick="removeHeader(this)">Remove</button>
                `;
                container.appendChild(headerRow);
            });
            
            showStatus(req.status === 'Error' ? 'error' : 'success', `${req.status} ${req.statusText} (${req.responseTime}ms)`);
        }

        function clearResponse() {
            document.getElementById('formattedView').innerHTML = `
                <div style="text-align: center; color: #666; margin-top: 100px;">
                    <p>No response yet. Send a webhook to see the response here.</p>
                </div>
            `;
            document.getElementById('rawContent').textContent = '';
            document.getElementById('htmlPreview').srcdoc = '';
            document.getElementById('headersContent').textContent = '';
            document.getElementById('analysisContent').textContent = '';
            document.getElementById('responseStatus').innerHTML = '';
            document.getElementById('responseTabs').style.display = 'none';
            document.querySelector('[data-tab="preview"]').style.display = 'none';
        }

        function copyResponse() {
            const activeTab = document.querySelector('.response-tab.active').dataset.tab;
            let response = '';
            
            if (activeTab === 'raw') {
                response = document.getElementById('rawContent').textContent;
            } else if (activeTab === 'formatted') {
                response = document.getElementById('formattedView').textContent;
            } else if (activeTab === 'preview') {
                response = document.getElementById('htmlPreview').srcdoc;
            } else if (activeTab === 'headers') {
                response = document.getElementById('headersContent').textContent;
            } else if (activeTab === 'analysis') {
                response = document.getElementById('analysisContent').textContent;
            }
            
            navigator.clipboard.writeText(response).then(() => {
                alert('Response copied to clipboard!');
            });
        }

        function downloadResponse() {
            const activeTab = document.querySelector('.response-tab.active').dataset.tab;
            let response = '';
            let filename = '';
            let mimeType = 'text/plain';
            
            if (activeTab === 'raw') {
                response = document.getElementById('rawContent').textContent;
                filename = `n8n-response-raw-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            } else if (activeTab === 'formatted') {
                response = document.getElementById('formattedView').textContent;
                filename = `n8n-response-formatted-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            } else if (activeTab === 'preview') {
                response = document.getElementById('htmlPreview').srcdoc;
                filename = `n8n-response-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.html`;
                mimeType = 'text/html';
            } else if (activeTab === 'headers') {
                response = document.getElementById('headersContent').textContent;
                filename = `n8n-response-headers-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            } else if (activeTab === 'analysis') {
                response = document.getElementById('analysisContent').textContent;
                filename = `n8n-response-analysis-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            }
            
            downloadFile(response, filename, mimeType);
        }

        function clearHistory() {
            requestHistory = [];
            performanceStats = {
                totalRequests: 0,
                totalResponseTime: 0,
                successfulRequests: 0,
                lastResponseSize: 0
            };
            renderHistory();
            
            // Reset performance stats display
            document.getElementById('totalRequests').textContent = '0';
            document.getElementById('avgResponseTime').textContent = '0ms';
            document.getElementById('successRate').textContent = '100%';
            document.getElementById('lastResponseSize').textContent = '0B';
        }
    </script>
</body>
</html>